# Burn Rate Monitor 详细设计

## 1. 数据结构

### 1.1 JSONL原始数据格式

```python
@dataclass
class UsageEntry:
    timestamp: datetime     # 时间戳
    cost_usd: float         # 实际成本（应用倍率后）
    original_cost_usd: float # 折扣前原价
    model: str              # 模型名称
    input_tokens: int       # 输入token数
    output_tokens: int      # 输出token数
    cache_creation_tokens: int  # 缓存创建token数
    cache_read_tokens: int      # 缓存读取token数
    upstream: str           # 上游来源（official/2api/droid等）
```

### 1.2 聚合数据格式

```python
@dataclass
class ModelData:
    model: str              # 模型名称
    cost_usd: float         # 实际成本
    original_cost_usd: float # 折扣前原价
    input_tokens: int
    output_tokens: int
    cache_creation_tokens: int
    cache_read_tokens: int
    count: int              # 请求次数
    upstream: str           # 上游来源

@dataclass
class MinuteData:
    minute: str             # "HH:MM"格式
    timestamp: datetime     # 完整时间戳
    cost_usd: float         # 该分钟总成本
    original_cost_usd: float # 折扣前原价
    input_tokens: int
    output_tokens: int
    cache_creation_tokens: int
    cache_read_tokens: int
    count: int              # 请求次数
    models: list[ModelData] # 按模型+upstream聚合
    upstream: str           # 上游来源（单一或mixed）
```

### 1.3 API响应格式

```python
@dataclass
class BurnRateResponse:
    current_rate: float           # 当前每分钟burn rate
    data: list[MinuteData]        # 时间序列数据
    stats: Stats                  # 统计信息

@dataclass
class Stats:
    total_cost: float             # 总成本
    original_total_cost: float    # 折扣前总成本
    average_rate: float           # 平均burn rate
    peak_rate: float              # 峰值burn rate
    peak_tokens: int              # 峰值tokens
    duration_minutes: int         # 持续时间
    models: list[ModelData]       # 模型统计（按模型+upstream聚合）
```

## 2. 模块详细设计

### 2.1 data_loader.py

**职责**: 读取和解析Claude JSONL文件

**核心函数**:

```python
def get_claude_data_dirs() -> list[Path]:
    """获取Claude数据目录列表"""
    pass

def load_jsonl_files(dirs: list[Path]) -> list[UsageEntry]:
    """加载所有JSONL文件"""
    pass

def parse_jsonl_line(line: str) -> UsageEntry | None:
    """解析单行JSONL"""
    pass
```

**数据目录搜索顺序**:
1. `~/.config/claude/projects/`
2. `~/.claude/projects/`

### 2.2 calculator.py

**职责**: 计算burn rate

**核心函数**:

```python
def aggregate_by_minute(entries: list[UsageEntry]) -> list[MinuteData]:
    """按分钟聚合数据"""
    pass

def calculate_burn_rate(data: list[MinuteData]) -> float:
    """计算当前burn rate"""
    pass

def calculate_stats(data: list[MinuteData]) -> Stats:
    """计算统计信息"""
    pass
```

### 2.3 server.py

**职责**: HTTP服务

**核心函数**:

```python
app = FastAPI()

@app.get("/")
async def index():
    """返回前端页面"""
    pass

@app.get("/api/burn-rate")
async def get_burn_rate(view: str = "current"):
    """获取burn rate数据"""
    pass

@app.get("/api/stats")
async def get_stats():
    """获取统计摘要"""
    pass

def main():
    """启动服务器，端口3001"""
    pass
```

## 3. 前端设计

### 3.1 页面布局

```
┌─────────────────────────────────────────────────┐
│  Burn Rate Monitor                              │
├─────────────────────────────────────────────────┤
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌────────┐│
│  │当前速率  │ │总Tokens │ │峰值速率  │ │总费用  ││
│  │12,345   │ │1.2M     │ │25,000   │ │$12.50  ││
│  └─────────┘ └─────────┘ └─────────┘ └────────┘│
├─────────────────────────────────────────────────┤
│                                                 │
│   ECharts 时间序列图表                           │
│   (按模型+upstream分组显示)                      │
│   (鼠标悬停显示具体值和upstream来源)              │
│                                                 │
├─────────────────────────────────────────────────┤
│  [Tokens] [费用]    ← 指标切换按钮               │
│  [当前块] [今日] [24小时]  ← 时间范围切换         │
└─────────────────────────────────────────────────┘
```

### 3.2 指标切换功能

- **Tokens模式**: Y轴显示token数量，适合观察使用量
- **费用模式**: Y轴显示USD成本，适合观察花费

### 3.3 ECharts配置要点

- 浅色主题（渐变橙色背景）
- tooltip悬停显示（包含upstream来源）
- X轴：时间（连续填充，无数据点显示为0）
- Y轴：tokens数或费用（根据当前模式）
- 多系列：按模型+upstream组合分组
- 线型区分：不同upstream使用不同虚线样式

## 4. 启动方式

```bash
# 开发安装
pip install -e .

# 启动服务
brmonitor

# 访问
http://localhost:3001
```
